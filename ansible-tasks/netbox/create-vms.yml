  - name: Create VM(s) in NetBox
    netbox.netbox.netbox_virtual_machine:
      netbox_url: "{{ secrets_cfg.netbox.api_proto }}://{{ secrets_cfg.netbox.api_host }}:{{ secrets_cfg.netbox.api_port}}"
      netbox_token: "{{ secrets_cfg.netbox.api_token }}"
      data:
        name: "{{ item.name }}"
        status: "Staged"
        tenant: "{{ item.tenant if item.tenant is defined else proxmox_vm_cfg.default_tenant }}"
        virtual_machine_role: "{{ proxmox_vm_cfg.default_vm_device_role }}"
        site: "{{ item.site if item.site is defined else proxmox_vm_cfg.default_site }}"
        cluster: "{{ item.vm_cluster if item.vm_cluster is defined else proxmox_vm_cfg.default_vm_cluster }}"
        vcpus: "{{ item.vcpus }}"
        memory: "{{ item.memory }}"
      state: present
    with_items: "{{ proxmox_vm_cfg.vms }}"
    when: nb_collected_staged_vms[item.name] is not defined and nb_collected_active_vms[item.name] is not defined
    register: vm_create

  - name: Store NetBox VM created state
    set_fact:
      nb_vm_created: "{{ nb_vm_created | combine({item['virtual_machine']['name']: True}) }}"
    when: item['virtual_machine'] is defined and item['virtual_machine']['status'] is defined and item['virtual_machine']['status'] == "staged"
    with_items: "{{ vm_create.results }}"
