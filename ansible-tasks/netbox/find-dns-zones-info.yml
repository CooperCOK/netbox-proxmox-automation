  - name: Find DNS zones in Netbox
    local_action:
      module: uri
      url: "{{ secrets_cfg.netbox.api_proto }}://{{ secrets_cfg.netbox.api_host }}:{{ secrets_cfg.netbox.api_port}}/api/plugins/netbox-dns/zones/?active=true"
      method: GET
      headers:
        Authorization: "Token {{ secrets_cfg.netbox.api_token }}"
        Accept: application/json
        Content-Type: application/json
      status_code: 200
      validate_certs: no
    when: nb_dns_plugin_changed
    register: dns_zones_changed

  - name: Gather SOA for DNS zone(s) from NetBox
    set_fact:
      nb_dns_plugin_soa: "{{ nb_dns_plugin_soa | combine({item.name: { 'origin': item.name, 'ttl': item.soa_ttl, 'soa_ns_name': item.soa_mname.name, 'soa_hostmaster': item.soa_rname, 'serial': item.soa_serial, 'refresh': item.soa_refresh, 'retry': item.soa_retry, 'expire': item.soa_expire, 'minimum': item.soa_minimum, 'nameservers': item.nameservers } }) }}"
    with_items: "{{ dns_zones_changed.json.results }}"
    when: nb_dns_plugin_changed

  - name: Collect name servers from NetBox (SOA)
    set_fact:
      nb_dns_plugin_ns: "{{ nb_dns_plugin_ns | combine({item: {'ns': nb_dns_plugin_soa[item].nameservers | selectattr('name', 'defined') | map(attribute='name') | list}}) }}"
    with_items: "{{ nb_dns_plugin_soa }}"
    when: nb_dns_plugin_changed
