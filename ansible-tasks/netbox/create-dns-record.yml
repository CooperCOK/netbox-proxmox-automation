#  - name: Show active NB VM
#    debug:
#      msg: "hostname: {{ item }} ip address: {{ nb_vm_inventory_staged[item]['ip'] }} zone: {{ nb_dns_plugin_zn[vm_config_create[item].domain_name] }} zone_id: {{ nb_dns_plugin_zn[vm_config_create[item].domain_name].zone_id }}"
#    loop: "{{ nb_vm_active }}"

  - name: Create DNS 'A' record in Netbox
    local_action:
      module: uri
      url: "{{ secrets_cfg.netbox.api_proto }}://{{ secrets_cfg.netbox.api_host }}:{{ secrets_cfg.netbox.api_port}}/api/plugins/netbox-dns/records/"
      method: POST
      headers:
        Authorization: "Token {{ secrets_cfg.netbox.api_token }}"
        Accept: application/json
        Content-Type: application/json
      body_format: json
      body:
        zone: "{{ nb_dns_plugin_zn[vm_config_create[item].domain_name].zone_id }}"
        type: A
        name: "{{ item }}"
        value: "{{ nb_vm_inventory_staged[item]['ip'].split('/')[0] }}"
        status: active
        managed: false
        disable_ptr: false
      status_code: 201
      validate_certs: no
    loop: "{{ nb_vm_active }}"
    register: dns_record_create
    failed_when: dns_record_create.status not in [200, 201, 400]

#  - name: Show DNS record create
#    debug:
#      msg: "hey DNS create {{ dns_record_create }}"

  - name: Set flag after DNS created record
    set_fact:
      nb_dns_plugin_changed: true
    loop: "{{ dns_record_create.results }}"
    when: item.status == 201
