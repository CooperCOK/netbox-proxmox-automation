  - name: Collect staged VM(s) to set as Decommissioning in NetBox
    set_fact:
      nb_vm_decomissioning: "{{ nb_vm_decomissioning + [item] }}"
    with_items: "{{ vm_config_remove }}"

#  - name: Update VM State to Active in NetBox
#    netbox.netbox.netbox_virtual_machine:
#      netbox_url: "{{ secrets_cfg.netbox.api_proto }}://{{ secrets_cfg.netbox.api_host }}:{{ secrets_cfg.netbox.api_port}}"
#      netbox_token: "{{ secrets_cfg.netbox.api_token }}"
#      data:
#        name: "{{ item['item'] }}"
#        status: "Active"
#      state: present
#    with_items: "{{ start_vms_job.results }}"

  - name: Update VM State to Decommissioning in NetBox
    netbox.netbox.netbox_virtual_machine:
      netbox_url: "{{ secrets_cfg.netbox.api_proto }}://{{ secrets_cfg.netbox.api_host }}:{{ secrets_cfg.netbox.api_port}}"
      netbox_token: "{{ secrets_cfg.netbox.api_token }}"
      data:
        name: "{{ item }}"
        status: "Decommissioning"
      state: present
    loop: "{{ nb_vm_decomissioning }}"
