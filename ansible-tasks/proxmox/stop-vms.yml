  - name: Stop specified VMs
    community.general.proxmox_kvm:
      node: "{{ secrets_cfg.proxmox.node }}"
      api_user: "{{ secrets_cfg.proxmox.api_user }}"
      api_token_id: "{{ secrets_cfg.proxmox.api_token_id }}"
      api_token_secret: "{{ secrets_cfg.proxmox.api_token_secret }}"
      api_host: "{{ secrets_cfg.proxmox.api_host }}"
      name: "{{ item }}"
      state: stopped
      force: true
    with_items: "{{ vm_config_remove }}"
    when: item in vm_config_remove and vm_config_remove[item] and item in collected_proxmox_vms
    register: stop_vms_job
    async: 180
    poll: 0

  - name: Wait for VM stop processes to finish
    async_status:
     #id: "{{ item.ansible_job_id }}"
      jid: "{{ item.ansible_job_id }}" # ansible version > 2.8
    register: _sjobs_alias_vc_0
    until: _sjobs_alias_vc_0.finished
    retries: 100
    delay: 10
    with_items: "{{ stop_vms_job.results }}"
    when: item.ansible_job_id is defined and not item.finished
