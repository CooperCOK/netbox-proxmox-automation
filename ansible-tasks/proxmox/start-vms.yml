  - name: Start VM
    community.general.proxmox_kvm:
      node: "{{ secrets_cfg.proxmox.node }}"
      api_user: "{{ secrets_cfg.proxmox.api_user }}"
      api_token_id: "{{ secrets_cfg.proxmox.api_token_id }}"
      api_token_secret: "{{ secrets_cfg.proxmox.api_token_secret }}"
      api_host: "{{ secrets_cfg.proxmox.api_host }}"
      name: "{{ item }}"
      state: started
    with_items: "{{ vm_config }}"
    when: vm_config[item].start
    register: start_vms_job
    async: 180
    poll: 0

  - name: Wait for VM start processes to finish
    async_status:
      #id: "{{ item.ansible_job_id }}"
      jid: "{{ item.ansible_job_id }}" # ansible version > 2.8
    register: _sjobs_alias_vc_0
    until: _sjobs_alias_vc_0.finished
    retries: 60
    delay: 10
    with_items: "{{ start_vms_job.results }}"
    when: item.ansible_job_id is defined

# THIS IS WRONG -- FIX
  - name: Wait for SSH on VMs to become available
    wait_for: host="{{ nb_vm_interface_assigned_ip[item] | regex_replace('/.*$', '') }}" port=22 delay=10 timeout=300
    with_items: "{{ nb_vm_interface_assigned_ip }}"
    #when: vm_config[item].exists and vm_config[item].start

  - name: Update VM State to Active in NetBox
    netbox.netbox.netbox_virtual_machine:
      netbox_url: "{{ secrets_cfg.netbox.api_proto }}://{{ secrets_cfg.netbox.api_host }}:{{ secrets_cfg.netbox.api_port}}"
      netbox_token: "{{ secrets_cfg.netbox.api_token }}"
      data:
        name: "{{ item['item'] }}"
        status: "Active"
      state: present
    with_items: "{{ start_vms_job.results }}"
